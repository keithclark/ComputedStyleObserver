{"version":3,"file":"computedStyleObserver.js","sources":["../src/ComputedStyleObserverEntry.js","../src/elementStateMonitor.js","../src/ComputedStyleObserver.js","../src/index.js"],"sourcesContent":["export default class {\n  constructor(target, property, value, prevValue) {\n    this.target = target;\n    this.property = property;\n    this.value = value;\n    this.previousValue = prevValue;\n  }\n}","import './ComputedStyleObserverEntry';\n\nconst POLLSTATE_RUNNING = 1;\nconst POLLSTATE_STOPPED = 0;\n\n\nlet pollState = POLLSTATE_STOPPED;\nlet elements = new Map();\n\n\n/**\n * Registers an element and an observer.\n * \n * @param {DOMElement}\n *   The element to watch\n * @param {ComputedStyleObserver} \n *   Observer instance responsible for handling changes\n */\nconst registerElement = (elem, observer) => {\n  let state = elements.get(elem);\n\n  if (!state) {\n    state = {\n      styles: {},\n      observers: []\n    }\n    elements.set(elem, state);\n  }\n\n  // only allow an observer to watch an element once\n  if (state.observers.includes(observer)) {\n    return false;\n  }\n\n  state.observers.push(observer);\n\n  // if we're not already polling the DOM, start now.\n  if (pollState !== POLLSTATE_RUNNING) {\n    pollState = POLLSTATE_RUNNING;\n    poll();\n  }\n\n  return true;\n}\n\n\n/**\n * \n * @param {DOMElement}\n *   The element to stop watching\n * @param {ComputedStyleObserver}\n *   Observer instance responsible for handling changes\n */\nconst unregisterElement = (elem, observer) => {\n  let state = elements.get(elem);\n  if (!state) {\n    return false;\n  }\n\n  let index = state.observers.indexOf(observer);\n\n  // if the observer doesn't exist, exit now\n  if (index === -1) {\n    return false;\n  }\n\n  state.observers.splice(index, 1);\n\n  // remove the element from the map if it has no observers\n  if (state.observers.length === 0) {\n    elements.delete(elem);\n  }\n\n  // if the map is empty, stop polling the DOM\n  if (elements.size === 0) {\n    pollState = POLLSTATE_STOPPED;\n  }\n\n  return true;\n}\n\n\n/**\n * Stop watching all elements for a specific observer\n */\nconst unregisterObserver = observer => {\n  elements.forEach((state, element) => {\n    if (state.observers.includes(observer)) {\n      unregisterElement(element, observer);\n    }\n  })\n}\n\n\n/**\n * Updates the state of every currently observed element\n */\nconst update = () => {\n  elements.forEach((state, element) => {\n    updateElementState(element, state);\n  });\n}\n\n\n/**\n * Determines if the `computedStyle` of the passed element has changed since\n * this function was last called. Any changes in `computedStyle` are filtered\n * against the property list of each ComputedStyleObserver and, if any\n * relevant changes exist, the observer callback is invoked with a list of\n * `ComputedStyleObserverEntry` objects.\n * \n * @param {DOMElement} elem\n *   The element to update\n * @param {Object} state\n *   The element's state object\n */\nconst updateElementState = (elem, state) => {\n  let styles = getComputedStyle(elem);\n  let newValues = {};\n\n  state.observers.forEach(observer => {\n    let changes = [];\n    \n    observer.properties.forEach(property => {\n      let value = styles[property];\n      let previousValue = state.styles[property];\n      if (value !== previousValue) {\n        if (previousValue) {\n          changes.push(new ComputedStyleObserverEntry(\n            elem,\n            property,\n            value,\n            previousValue\n          ));\n        }\n      }\n      newValues[property] = value;\n    });\n\n    if (changes.length) {\n      observer.callback(changes);\n    }\n  })\n\n  state.styles = newValues;\n}\n\n\n/**\n * Start watching elements for changes.\n */\nconst poll = () => {\n  if (pollState === POLLSTATE_RUNNING) {\n    requestAnimationFrame(poll);\n    update();\n  }\n}\n\n\nexport {\n  registerElement,\n  unregisterElement,\n  unregisterObserver\n}\n","import {registerElement, unregisterElement, unregisterObserver} from './elementStateMonitor';\n\nlet observers = new WeakMap();\n\nexport default class {\n\n  constructor(callback, properties = null) {\n\n    if (Array.isArray(properties)) {\n      properties = [...properties];\n    }\n\n    observers.set(this, {callback, properties});\n  }\n\n  disconnect() {\n    unregisterObserver(observers.get(this));\n  }\n\n  observe(targetElement) {\n    return registerElement(targetElement, observers.get(this));\n  }\n\n  unobserve(targetElement) {\n    return unregisterElement(targetElement, observers.get(this));\n  }\n\n}\n","import ComputedStyleObserver from './ComputedStyleObserver';\nimport ComputedStyleObserverEntry from './ComputedStyleObserverEntry';\n\nwindow.ComputedStyleObserver = ComputedStyleObserver;\nwindow.ComputedStyleObserverEntry = ComputedStyleObserverEntry;\n"],"names":["ComputedStyleObserverEntry"],"mappings":"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"}